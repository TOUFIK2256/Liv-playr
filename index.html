<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-PTV Auto Fix</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  
  <style>
    body { margin: 0; background: #000; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .video-container { width: 100%; max-width: 1000px; aspect-ratio: 16/9; background: #000; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    video { width: 100%; height: 100%; background: #000; }
    .shaka-spinner-svg { display: none; }
  </style>
</head>
<body>

  <div class="video-container" data-shaka-player-container>
    <video data-shaka-player autoplay playsinline id="video"></video>
  </div>

<script>
const M3U_URL = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u";

async function init() {
  const urlParams = new URLSearchParams(window.location.search);
  const searchName = urlParams.get('id'); 

  if (!searchName) {
    alert("URL-এ নাম দিন। যেমন: ?id=Hungama");
    return;
  }

  try {
    const video = document.getElementById('video');
    const ui = video['ui'];
    const player = ui.getControls().getPlayer();
    
    // Error Handling
    player.addEventListener('error', (e) => console.error("Error Code:", e.detail.code, e.detail));

    // M3U Fetch
    const req = await fetch(M3U_URL);
    const txt = await req.text();
    const lines = txt.split('\n');

    let data = { url: '', kid: '', key: '', cookie: '' };
    let found = false;

    // Advanced Parsing Logic for your specific Format
    for (let i = 0; i < lines.length; i++) {
      // নাম খোঁজা (Comma-r pore)
      if (lines[i].includes(',' + searchName) || lines[i].includes(', ' + searchName)) {
        found = true;
        
        // আশপাশের ২০ লাইন চেক করা হবে
        let buffer = lines.slice(Math.max(0, i-5), i+20).join('\n');
        
        // 1. URL
        const urlMatch = buffer.match(/(https?:\/\/[^\s]+\.mpd[^\s]*)/);
        if (urlMatch) data.url = urlMatch[0];

        // 2. Key (License)
        const keyMatch = buffer.match(/license_key=([a-f0-9]{32}):([a-f0-9]{32})/);
        if (keyMatch) {
            data.kid = keyMatch[1];
            data.key = keyMatch[2];
        }

        // 3. Cookie (Format: "cookie":"value")
        const cookieMatch = buffer.match(/"cookie":"([^"]+)"/);
        if (cookieMatch) {
            data.cookie = cookieMatch[1];
        }

        break;
      }
    }

    if (found && data.url) {
      console.log("Channel Found:", searchName);
      playStream(player, data);
    } else {
      alert("Channel Not Found or Offline");
    }

  } catch (e) { console.error("Setup Error:", e); }
}

function playStream(player, data) {
  // 1. ClearKey Setup
  if (data.kid && data.key) {
    let drm = {};
    drm[data.kid] = data.key;
    player.configure({ 
        drm: { clearKeys: drm },
        streaming: { bufferingGoal: 60, lowLatencyMode: true } // बuffering বাড়ানো হলো
    });
  }

  // 2. Header & URL Injection
  player.getNetworkingEngine().clearAllRequestFilters();
  player.getNetworkingEngine().registerRequestFilter((type, request) => {
    
    // Headers
    request.headers['User-Agent'] = "plaYtv/7.1.3 (Linux; Android 13) ygx/69.1 ExoPlayerLib/824.0";
    request.headers['Referer'] = "https://www.jiotv.com/";
    
    if (data.cookie) {
        request.headers['Cookie'] = data.cookie;
    }

    // *** FIX: Cookie in URL (Segments needs this) ***
    if (data.cookie && request.uris[0]) {
        // যদি URL-এ ইতিমধ্যে কুকি না থাকে, তবেই যোগ করবে
        if (!request.uris[0].includes('hdnea=')) {
            const separator = request.uris[0].includes('?') ? '&' : '?';
            request.uris[0] += separator + data.cookie;
        }
    }
  });

  player.load(data.url).catch(e => console.error("Load Failed:", e));
}

document.addEventListener('shaka-ui-loaded', init);
</script>

</body>
</html>
