<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>M3U Auto Parser</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  <style>
    body { margin: 0; background: #000; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .video-container { width: 100%; height: 100%; max-width: 1000px; aspect-ratio: 16/9; background: #000; position: relative; }
    video { width: 100%; height: 100%; background: #000; }
  </style>
</head>
<body>

  <div class="video-container" data-shaka-player-container>
    <video data-shaka-player autoplay playsinline id="video"></video>
  </div>

<script>
// আপনার M3U ফাইলের লিংক
const M3U_URL = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u";

async function init() {
  const urlParams = new URLSearchParams(window.location.search);
  const searchName = urlParams.get('id'); // URL থেকে নাম নেবে (যেমন ?id=Hungama)

  if (!searchName) {
    alert("URL-এ নাম দিন। যেমন: index.html?id=Hungama");
    return;
  }

  try {
    const video = document.getElementById('video');
    const ui = video['ui'];
    const player = ui.getControls().getPlayer();

    // M3U ডাউনলোড এবং রিড করা
    const req = await fetch(M3U_URL);
    const txt = await req.text();
    const lines = txt.split('\n');

    let targetData = {};
    let found = false;

    for (let i = 0; i < lines.length; i++) {
      // নাম খোঁজা হচ্ছে (কমা-র পরে বা লাইনের শেষে)
      if (lines[i].includes(searchName) && lines[i].includes('#EXTINF')) {
        found = true;
        
        // নাম পাওয়ার পর, নিচের ১০-১৫ লাইন স্ক্যান করবে বাকি তথ্যের জন্য
        let chunk = lines.slice(i, i + 15).join('\n');
        
        // ১. URL বের করা
        const urlMatch = chunk.match(/(https?:\/\/[^\s]+\.mpd[^\s]*)/);
        if (urlMatch) targetData.url = urlMatch[0];

        // ২. Key ID এবং Key বের করা
        const keyMatch = chunk.match(/license_key=([a-f0-9]+):([a-f0-9]+)/);
        if (keyMatch) {
            targetData.kid = keyMatch[1];
            targetData.key = keyMatch[2];
        }

        // ৩. Cookie বের করা
        const cookieMatch = chunk.match(/"cookie":"([^"]+)"/);
        if (cookieMatch) targetData.cookie = cookieMatch[1];

        break;
      }
    }

    if (found && targetData.url) {
      console.log("Playing Channel:", searchName);
      playChannel(player, targetData);
    } else {
      alert("চ্যানেল পাওয়া যায়নি!");
    }

  } catch (e) { console.error(e); }
}

function playChannel(player, data) {
  // কনফিগারেশন সেট করা
  let drmConfig = {};
  if (data.kid && data.key) {
    let keys = {};
    keys[data.kid] = data.key;
    drmConfig = { clearKeys: keys };
  }

  player.configure({
    drm: drmConfig,
    streaming: { bufferingGoal: 30, lowLatencyMode: true }
  });

  // হেডার সেট করা (Cookie & UA)
  player.getNetworkingEngine().clearAllRequestFilters();
  player.getNetworkingEngine().registerRequestFilter((type, request) => {
    request.headers['User-Agent'] = "plaYtv/7.1.3 (Linux; Android 13) ygx/69.1 ExoPlayerLib/824.0";
    request.headers['Referer'] = "https://www.jiotv.com/";
    if (data.cookie) request.headers['Cookie'] = data.cookie;
  });

  player.load(data.url).catch(e => console.error("Load Error:", e));
}

document.addEventListener('shaka-ui-loaded', init);
</script>

</body>
</html>
