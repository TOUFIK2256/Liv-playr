<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SonyLIV Sports 5 - Auto Fixed</title>
  <!-- Shaka Player UI & Style -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  
  <style>
    body { margin: 0; background: #000; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .video-container { width: 100%; height: 100%; max-width: 1200px; }
    video { width: 100%; height: 100%; background: #000; }
  </style>
</head>
<body>

  <div class="video-container" data-shaka-player-container>
    <video data-shaka-player autoplay playsinline id="video"></video>
  </div>

<script>
async function initPlayer() {
  // 1. Setup Shaka Player
  const video = document.getElementById('video');
  const ui = video['ui'];
  const controls = ui.getControls();
  const player = controls.getPlayer();
  window.player = player; // For debug

  // 2. Configuration Data (আপনার দেওয়া তথ্য)
  const STREAM_URL = "https://jiotvpllive.cdn.jio.com/bpk-tv/SonyLIV_Sports_5_MOB/WDVLive/index.mpd";
  const GITHUB_M3U = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u";
  const BACKUP_API = "https://crickettv.site/api/cookie.json"; // যদি লাগে
  
  // ClearKey DRM (আপনার দেওয়া কী)
  const DRM_CONFIG = {
    clearKeys: {
      "cee8550bf50b569d8ad2ed0c5264f0d2": "565a95f1c332c03534e1e5fcc1ff9a8b"
    }
  };

  player.configure({ drm: DRM_CONFIG });

  // 3. Cookie Fetching Logic (GitHub থেকে)
  let cookieHeader = "";
  
  try {
    console.log("Fetching Cookie from GitHub...");
    const response = await fetch(GITHUB_M3U);
    const text = await response.text();
    const lines = text.split('\n');
    
    // লাইন বাই লাইন চেক করা হচ্ছে
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].includes('Star_Sports_HD')) { // টার্গেট চ্যানেল খোঁজা
        // ঠিক আগের লাইনগুলোতে কুকি খোঁজা
        for (let j = i - 1; j >= 0; j--) {
          if (lines[j].includes('#EXTHTTP:') && lines[j].includes('cookie')) {
            const match = lines[j].match(/"cookie":"([^"]+)"/);
            if (match) {
              cookieHeader = match[1];
              console.log("Cookie Found:", cookieHeader);
            }
            break;
          }
        }
        break;
      }
    }
  } catch (e) {
    console.error("GitHub Fetch Failed, trying backup...");
  }

  // যদি গিটহাবে না পায়, ব্যাকআপ API ট্রাই করবে (Optional)
  if (!cookieHeader) {
     try {
        const res = await fetch(BACKUP_API);
        const data = await res.json();
        cookieHeader = data.cookie;
     } catch(e) { console.error("Backup Failed too"); }
  }

  // 4. Request Filters (ছদ্মবেশ ধরা)
  player.getNetworkingEngine().registerRequestFilter(function(type, request) {
    if (cookieHeader) {
        request.headers['Cookie'] = cookieHeader;
        
        // URL-এর পেছনেও কুকি লাগিয়ে দেওয়া হচ্ছে (Double Safety)
        if (request.uris[0] && !request.uris[0].includes('__hdnea=')) {
            const separator = request.uris[0].includes('?') ? '&' : '?';
            request.uris[0] += separator + cookieHeader;
        }
    }
    
    // Jio সার্ভারের জন্য হেডার
    request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
    request.headers['Referer'] = "https://www.jiotv.com/";
  });

  // 5. Load Video
  try {
    await player.load(STREAM_URL);
    console.log("Video Loaded Successfully!");
  } catch (e) {
    console.error("Error loading video:", e);
  }
}

document.addEventListener('shaka-ui-loaded', initPlayer);
</script>

</body>
</html>
