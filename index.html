<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SonyLIV/Jio Auto Fix</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css">
  
  <style>
    body { margin: 0; background: #000; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .video-container { width: 100%; max-width: 1000px; aspect-ratio: 16/9; background: #000; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    video { width: 100%; height: 100%; background: #000; }
    .shaka-spinner-svg { display: none; }
  </style>
</head>
<body>

  <div class="video-container" data-shaka-player-container>
    <video data-shaka-player autoplay playsinline id="video"></video>
  </div>

<script>
const M3U_URL = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u";

async function init() {
  const urlParams = new URLSearchParams(window.location.search);
  const searchName = urlParams.get('id'); 

  if (!searchName) {
    alert("URL-এ নাম দিন। যেমন: ?id=Hungama");
    return;
  }

  try {
    const video = document.getElementById('video');
    const ui = video['ui'];
    const player = ui.getControls().getPlayer();

    // ডিবাগ: এরর চেক করা
    player.addEventListener('error', (e) => console.error("Error:", e.detail));

    const req = await fetch(M3U_URL);
    const txt = await req.text();
    const lines = txt.split('\n');

    let data = { url: '', kid: '', key: '', cookie: '' };
    let found = false;

    for (let i = 0; i < lines.length; i++) {
      // নাম খোঁজা (যেকোনো ফরম্যাটে)
      if (lines[i].includes(searchName) && lines[i].includes('#EXTINF')) {
        found = true;
        
        // আশপাশের ৩০ লাইন স্ক্যান করবে (Range বাড়ানো হয়েছে)
        let buffer = lines.slice(Math.max(0, i-10), i+20).join('\n');
        
        // ১. URL বের করা
        const urlMatch = buffer.match(/(https?:\/\/[^\s]+\.mpd[^\s]*)/);
        if (urlMatch) data.url = urlMatch[0].trim();

        // ২. Key বের করা (Regex ফিক্স করা হয়েছে: বড়/ছোট হাতের অক্ষর ধরবে)
        // ফরম্যাট: license_key=kid:key
        const keyMatch = buffer.match(/license_key=([a-zA-Z0-9]+):([a-zA-Z0-9]+)/);
        if (keyMatch) {
            data.kid = keyMatch[1];
            data.key = keyMatch[2];
            console.log("Key Found:", data.kid, data.key);
        }

        // ৩. Cookie বের করা
        const cookieMatch = buffer.match(/"cookie":"([^"]+)"/);
        if (cookieMatch) {
            data.cookie = cookieMatch[1];
            console.log("Cookie Found");
        }

        break;
      }
    }

    if (found && data.url) {
      playStream(player, data);
    } else {
      alert("Channel Not Found!");
    }

  } catch (e) { console.error("Setup Error:", e); }
}

function playStream(player, data) {
  // ১. DRM কনফিগারেশন
  let drmConfig = {};
  if (data.kid && data.key) {
    let keys = {};
    keys[data.kid] = data.key;
    drmConfig = { clearKeys: keys };
  }

  player.configure({ 
    drm: drmConfig,
    manifest: {
        dash: { ignoreMinBufferTime: true } // টাইমিং ফিক্স
    },
    streaming: { 
        bufferingGoal: 10, 
        lowLatencyMode: true,
        inaccurateManifestTolerance: 0,
        jumpLargeGaps: true
    } 
  });

  // ২. হেডার এবং URL মডিফিকেশন
  player.getNetworkingEngine().clearAllRequestFilters();
  player.getNetworkingEngine().registerRequestFilter((type, request) => {
    
    // Header Injection
    request.headers['User-Agent'] = "plaYtv/7.1.3 (Linux; Android 13) ygx/69.1 ExoPlayerLib/824.0";
    request.headers['Referer'] = "https://www.jiotv.com/";
    
    if (data.cookie) {
        request.headers['Cookie'] = data.cookie;
    }

    // URL Injection (Segment-এর জন্য জরুরি)
    if (data.cookie && request.uris[0]) {
        // শুধু যদি কুকি না থাকে, তবেই অ্যাড করবে
        if (!request.uris[0].includes('hdnea=')) {
            const separator = request.uris[0].includes('?') ? '&' : '?';
            request.uris[0] += separator + data.cookie;
        }
    }
  });

  player.load(data.url).then(() => {
    console.log("Playing...");
  }).catch(e => {
    console.error("Load Failed:", e);
    alert("Video load failed. Check Console.");
  });
}

document.addEventListener('shaka-ui-loaded', init);
</script>

</body>
</html>
